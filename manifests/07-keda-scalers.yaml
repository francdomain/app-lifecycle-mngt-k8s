---
# KEDA ScaledObjects for Event-Driven Autoscaling
# Configured to work without Prometheus using CPU and Memory metrics
# Note: To add custom HTTP request-based scaling, install Prometheus and add triggers:
#   - type: prometheus
#     metadata:
#       serverAddress: http://prometheus:9090
#       metricName: http_request_rate
#       threshold: "100"
#       query: sum(rate(nginx_http_requests_total{job="frontend"}[30s]))

# Frontend ScaledObject - Scale based on CPU and Memory utilization
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: frontend-scaler
  namespace: ecommerce
spec:
  scaleTargetRef:
    name: frontend
  minReplicaCount: 2
  maxReplicaCount: 10
  triggers:
  # CPU-based scaling using kubernetes-workload trigger
  - type: kubernetes-workload
    metadata:
      podSelector: 'app=frontend'
      value: "70"
      type: "Resource"
      resource: "cpu"
  advanced:
    horizontalPodAutoscalerConfig:
      behavior:
        scaleUp:
          stabilizationWindowSeconds: 30
          policies:
          - type: Percent
            value: 100
            periodSeconds: 30
          - type: Pods
            value: 2
            periodSeconds: 30
          selectPolicy: Max
        scaleDown:
          stabilizationWindowSeconds: 300
          policies:
          - type: Percent
            value: 50
            periodSeconds: 60
          - type: Pods
            value: 1
            periodSeconds: 60
          selectPolicy: Min

---
# API Gateway ScaledObject - Scale based on CPU and Memory
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: api-gateway-scaler
  namespace: ecommerce
spec:
  scaleTargetRef:
    name: api-gateway
  minReplicaCount: 2
  maxReplicaCount: 8
  triggers:
  # Primary: CPU-based trigger
  - type: cpu
    metadata:
      metricType: Utilization
      value: "75"
  # Secondary: Memory trigger
  - type: memory
    metadata:
      metricType: Utilization
      value: "80"
  advanced:
    horizontalPodAutoscalerConfig:
      behavior:
        scaleUp:
          stabilizationWindowSeconds: 0
          policies:
          - type: Percent
            value: 100
            periodSeconds: 30
          - type: Pods
            value: 1
            periodSeconds: 30
          selectPolicy: Max
        scaleDown:
          stabilizationWindowSeconds: 300
          policies:
          - type: Percent
            value: 50
            periodSeconds: 60
          selectPolicy: Min

---
# Product Service ScaledObject - Scale based on CPU and Memory
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: product-service-scaler
  namespace: ecommerce
spec:
  scaleTargetRef:
    name: product-service
  minReplicaCount: 2
  maxReplicaCount: 6
  triggers:
  # Primary: CPU-based trigger
  - type: cpu
    metadata:
      metricType: Utilization
      value: "80"
  # Secondary: Memory trigger
  - type: memory
    metadata:
      metricType: Utilization
      value: "75"
  advanced:
    horizontalPodAutoscalerConfig:
      behavior:
        scaleUp:
          stabilizationWindowSeconds: 60
          policies:
          - type: Percent
            value: 50
            periodSeconds: 60
          selectPolicy: Max
        scaleDown:
          stabilizationWindowSeconds: 300
          policies:
          - type: Percent
            value: 25
            periodSeconds: 120
          selectPolicy: Min

---
# Order Service ScaledObject - Scale based on CPU and Memory
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: order-service-scaler
  namespace: ecommerce
spec:
  scaleTargetRef:
    name: order-service
  minReplicaCount: 2
  maxReplicaCount: 6
  triggers:
  # Primary: CPU-based trigger
  - type: cpu
    metadata:
      metricType: Utilization
      value: "80"
  # Secondary: Memory trigger
  - type: memory
    metadata:
      metricType: Utilization
      value: "80"
  advanced:
    horizontalPodAutoscalerConfig:
      behavior:
        scaleUp:
          stabilizationWindowSeconds: 30
          policies:
          - type: Percent
            value: 100
            periodSeconds: 30
          selectPolicy: Max
        scaleDown:
          stabilizationWindowSeconds: 300
          policies:
          - type: Percent
            value: 50
            periodSeconds: 60
          selectPolicy: Min
